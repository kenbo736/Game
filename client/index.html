<canvas id="ctx" width="1152" height="768" style="border:1px solid #000000"></canvas>

<div id="chat-text" style="width:1152px; height:100px; overflow-y:scroll">
  <div>Hello</div>
</div>

<form id="chat-form">
  <input id="chat-input" type="text" style="width:1152px"></input>
</form>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
    var currentMap = null;

    var chatText = document.getElementById('chat-text');
    var chatInput = document.getElementById('chat-input');
    var chatForm = document.getElementById('chat-form');
    var ctx = document.getElementById("ctx").getContext("2d");

    var characterimage = new Image();
    characterimage.src = '/client/img/player.png';

    var bulletimage = new Image();
    bulletimage.src = '/client/img/bullet.png';

    var background = new Image();
    background.src = '/client/img/bg.png';
    
    ctx.font = '30px Arial';
    
    var Player = function(initPack){
        var self = {};
        self.id = initPack.id;
        self.number = initPack.number;
        self.x = initPack.x;
        self.y = initPack.y;
        self.hp = initPack.hp;
        self.hpMax = initPack.hpMax;
        self.score = initPack.score;
       
        self.draw = function(){
            var hpWidth = 30 * self.hp / self.hpMax;
            ctx.fillRect(self.x - hpWidth/2,self.y - 40,hpWidth,4);
            ctx.fillText(self.number,self.x,self.y);
           
            ctx.fillText(self.score,self.x,self.y-60);
        }
        Player.list[self.id] = self;
       

        return self;
    }
    Player.list = {};
    
    var Bullet = function(initPack){
        var self = {};
        self.id = initPack.id;
        self.x = initPack.x;
        self.y = initPack.y;
       
        self.draw = function(){        
            ctx.fillRect(self.x-5,self.y-5,10,10);
        }
       
        Bullet.list[self.id] = self;       
        return self;
    }
    Bullet.list = {};
    
    var socket = io();
    var myId = 0.0;
    var cameraX = 0;
    var cameraY = 0;
    
    socket.on('newPlayerId', function(data) {
        myId = data;
    });

    socket.on('mapUpdate', function(data) {
        currentMap = data;
    });
    
    socket.on('update', function(data) {
    
        ctx.clearRect(0, 0, 1152, 768);

        if (currentMap !== null) {
            for (var x = 0; x < currentMap.width; ++x) {
                for (var y = 0; y < currentMap.height; ++y) {
		            if ((x+1)*50 > cameraX && x*50 < cameraX+1152 && (y+1)*50 > cameraY && y*50 < cameraY+768)        {
			            ctx.drawImage(background, x*50-cameraX, y*50-cameraY);
		            }
                }
            }
        }

        for(var i = 0; i < data.player.length; i++) {
            ctx.drawImage(characterimage, data.player[i].x - cameraX, data.player[i].y - cameraY, 50, 70);
	    if (data.player[i].id === myId) {
	    	cameraX = data.player[i].x - 530;
	    	cameraY = data.player[i].y - 370;
        }
	}
            
        for(var i = 0; i < data.bullet.length; i++) {
            //ctx.fillRect(data.bullet[i].x-5-cameraX, data.bullet[i].y-5-cameraY, 10, 10);
	    ctx.save();
	    var midX = data.bullet[i].x+25-cameraX;
	    var midY = data.bullet[i].y+22-cameraY;
	    ctx.translate(midX, midY);
	    ctx.rotate(data.bullet[i].angle);
	    ctx.drawImage(bulletimage, data.bullet[i].x-5-cameraX-midX, data.bullet[i].y-5-cameraY-midY, 40, 45);
	    ctx.restore();
        }
    });

    socket.on('addToChat', function(data) {
        chatText.innerHTML += '<div>' + data + '</div>';
    });
    socket.on('evalAnswer', function(data) {
        console.log(data);
    });

    chatForm.onsubmit = function(e) {
        e.preventDefault();
        if(chatInput.value[0] === '/')
            socket.emit('evalServer', chatInput.value.slice(1));
        else
            socket.emit('sendMsgToServer', chatInput.value);
        chatInput.value = '';
    }
                           
    document.onkeydown = function(event) {
        if(event.keyCode === 68) //d
            socket.emit('keyPress', {inputId:'right', state:true});
        else if(event.keyCode === 83) //s
            socket.emit('keyPress', {inputId:'down', state:true});
        else if(event.keyCode === 65) //a
            socket.emit('keyPress', {inputId:'left', state:true});
        else if(event.keyCode === 87) //w
            socket.emit('keyPress', {inputId:'up', state:true});
    }
    document.onkeyup = function(event) {
        if(event.keyCode === 68) //d
            socket.emit('keyPress', {inputId:'right', state:false});
        else if(event.keyCode === 83) //s
            socket.emit('keyPress', {inputId:'down', state:false});
        else if(event.keyCode === 65) //a
            socket.emit('keyPress', {inputId:'left', state:false});
        else if(event.keyCode === 87) //w
            socket.emit('keyPress', {inputId:'up', state:false});
    }
    
    document.onmousedown = function(event) {
        socket.emit('keyPress', {inputId:'attack', state:true});
    }
    document.onmouseup = function(event) {
        socket.emit('keyPress', {inputId:'attack', state:false});
    }
    document.onmousemove = function(event) {
        var x = -530 + event.clientX - 8;
        var y = -370 + event.clientY -8;
        var angle = Math.atan2(y, x) / Math.PI * 180;
        socket.emit('keyPress', {inputId:'mouseAngle', state:angle});
    }
</script>
